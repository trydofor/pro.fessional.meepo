# pro.fessional.meepo

米波，地卜师，主狗和分身狗具有同等的技能和待遇。  
一个基于注释和标记的不破坏母版语法的模板引擎翻译器。

![meepo](./meepo_full.png)

解决现代模板引擎语法，会破坏其模板文件本身的预览和编辑的特性。  
米波只做中间层翻译，类似C的宏功能，支持任何有注释的语言做模板。

 * 从`java`生成`*.java`，模板和目标都是可编译
 * 从`sql`生成`*.sql`，模板和目标都可以执行
 * 从`htm`生成`*.htm`，模板和目标都可以预览

## 1.模板特性

在使用模板的场景中，特别希望模板的语法不被破坏，以便在预览和修改时有原生特性。  
有自己语法特征的模板为`母版`，如java`母版`，直接用可编译的`Tmpl.java`。

在`母版`中通过`注释`做语法标记，逐行处理规则替换，以输出`底层模板(backend)`。
母版的处理分为`解析parse`和`合并merge`两个过程，解析时会依赖正则表达式。
合并时，除了部分`RNA`外，都是直接输出，效能等于`StringBuilder.append`。

因没有`流程控制`及`执行函数`的功能，所以一次`解析`替换后，后续`合并`非常高效。
米波的进行模板翻译但不依赖其他模板，但测试中使用pebble（benchmark和语法较好）

 * [pebble template](https://pebbletemplates.io/)
 * [template-benchmark](https://github.com/trydofor/template-benchmark)

## 2.语法概要

米波模板语法中，存在以下基础语素和约定。

 * `空白` - 一个`0x20`或`0x09`，即英文空格或`\t`
 * `英数` - `[a-zA-z0-9]`，英文字母和数字，区分大小写
 * `母版注释` - 母版语言的注释（多行的开始），如,`//`，`/*`
 * `指令` - 米波语法中特殊意义的特征标记，如前缀
 * `DNA` - defined native annotation
 * `RNA` - runnable native annotation
 * `?+*` - 分别为`[0,`]`，`[1,∞)`，`[0,∞)`
 * 指令所在行，只被`米波`解析，对底层模板不可见
 * 指令格式后的空白及其他字符，无视（仅当注释）

为了简化，后续举例中，省略领起`指令`的`母版注释`+`空白`

 * `H!MEEPO` 嗨！米波，用来定义`母版注释`，以便后续解析
 * `DNA:SET` 设定替换，在一个范围内定义一个模板替换。
 * `DNA:END` 结束作用，结束多个`作用`的作用域。
 * `DNA:BKB` 免疫区域，被`END`之前的区域不进行解析。
 * `DNA:RAW` 原生模板，执行后面的原生模板语法。
 * `RNA:PUT` 存入变量，使用引擎运行`执行体`，结果存入环境。
 * `RNA:USE` 使用变量，使用环境变量，内置或`PUT`的变量。
 * `RNA:RUN` 每次执行，每次都会执行功能体，比如计数器。

因为解析时使用了java的RegExp作为底层实现，所以需要一定的基础。

 * 查找中，常误用字符有`.^$?+*{}()[]\|`。`[]`内字符有些不用转义。
 * 替换中，`\`主要用作`反向引用`，部分`()`组合有特殊含义。

在处理`回车换行CRLF`时，以`\n`断行，window的`\r\n`也做`\n`处理。
单行注释型，若结尾有`\n`，会作为语法的结束符，即合并时不会输出。

### 2.1.H!MEEPO 嗨！米波

语法：`注释头` `空白`? `H!MEEPO` `空白`? `注释尾`?

定义`注释`并标识此文件为`米波`模板，以解析其后续`母版`。

 * `注释头` - 单行注释或多行注释的首部，前一个非`空白`字符串
 * `H!MEEPO` - 这么怪的名字(hi meepo)，主要是避免重复和转义。
 * `注释尾` - 多行注释的结尾，后一个非`空白`字符串

`嗨！米波`必须独占一行，最好有`空白`分割，以便阅读时清晰。
类似sql的`DELIMITER`定义结束符的用法和作用，举例如下，

 * java - `// H!MEEPO`，以`//`为注释
 * java - `/* H!MEEPO */`，又以`/*`为注释
 * sql -  `-- H!MEEPO`，以`--`为注释
 * bash -  `# H!MEEPO`，以`#`为注释
 * html = `<!-- H!MEEPO -->`

注意，`注释头`存在尾字符叠字的情况，米波不处理重叠字，举例如下，

 * `/*` - `/***** DNA:RAW`，无效
 * `//` - `////// DNA:RAW`，从最后一个`//`开始
 * `#` - `##### DNA:RAW`，从最后一个`#`开始

对于后续文本（DNA和RNA）的解析，存在行解析和块解析2种，规则如下

 * `H!MEEPO` 始终是行解析，必须独占一行。
 * `单行注释`型米波，会按行解析，按行解析。
 * `多行注释`型米波，会跨行读取，按块解析。

后续举例中，都以`// H!MEEPO` 为例，但省略书写。

## 3.厂长DNA

DNA好比一个厂长，定义替换指令，在parse时，进行高效的静态文本替换。

### 3.1.DNA:SET 设定替换

语法：`DNA:SET` `空白`+ `界定` `查找` `界定` `替换` `界定` `作用`?

在一定作用域内，把符合特征的字符串替换成底层模板的字符串。其中，

 * `界定` - 第1个非(`空白`,`!`,`英数`)字符，常用的有`/`。
 * `查找` - 不含`界定`的正则特征，存在分组时参考`分组引用`。
 * `查找`为空时，忽略此`SET`。
 * `替换` - 不含`界定`的正则特征，存在引用时参考`分组引用`。
 * `替换`为空时，表示删除，即替换成空。
 * `作用` - 生效的作用次数，即到何时结束作用，非`空白`。

`分组引用`指查找时有`()`的group或替换时使用`\1`的反向引用的情况。  
这会对特征字符串的边界有影响，也要避开书写复杂的表达式，约定规则如下，

 * 如果`查找`中无group，在使用group(0)，即全部匹配。
 * 如果`查找`有group时，取第一个`(`，即group(1)内容。
 * 如`((A)(B(C)))`，按`(`从左到右出现的顺序计数。
    - group(1) - ((A)(B(C)))
    - group(2) - (A)
    - group(3) - (B(C))
    - group(4) - (C)

`作用`即`作用次数`或`作用域`，默认作用`1`次，`*`表示`匿名`的无限次。

 * `次数`，以`,`分隔的单次或`-`连接的闭区间，如`1-3,15`。
 * `命名`的无限次作用，可被`END`结束。

``` js
// DNA:SET /false/{{user.male}}/
var isMale = false;
/* 只把此行的false替换为user.male模板变量。底层模板输出为:
var isMale = {{user.male}};
*/
```

### 3.2.DNA:END 结束作用

语法：`DNA:END` (`空白`+ `作用`)+

结束多个指令产生的`作用`的作用域，如`SET`的命名作用域。

``` js
// DNA:SET /1010100/{{id}}/id
// DNA:SET /"(性别)"/{{desc}}/1
// DNA:SET /性别/{{info}}/2
SUPER(1010100, "ConstantEnumTemplate", "性别", "性别")
// DNA:END id
/* 分别定义，命名的id；group(1)的desc；第2次匹配的info。底层模板输出为:
SUPER({{id}}, "ConstantEnumTemplate", "{{desc}}", "{{info}}")
*/
```

### 3.3.DNA:BKB 免疫区域

语法：`DNA:BKB` `空白`+ `作用`

定义一个`命名`的全局免疫作用，可以被`END`结束，之间的文本不被米波处理。

``` js
// DNA:BKB 黑皇杖
// DNA:SET /"(性别)"/desc/1
SUPER(1010100, "ConstantEnumTemplate", "性别", "性别")
// DNA:END 黑皇杖
/* 无视了SET指令，底层模板输出为:
// DNA:SET /"(性别)"/desc/1
SUPER(1010100, "ConstantEnumTemplate", "性别", "性别")
*/
```

### 3.4.DNA:RAW 原生模板

语法：`DNA:RAW` `空白`+ `原生模板`

用注释的语法定义一个`模板`，用以弥补`母版`语法不支持的情况。
使用单行注释表意清晰，多行注释时，只保留头尾直接的内容。
效果是，删除`注释头`至`DNA:RAW`，和`注释尾`。

``` js
/* 以下两行具有相同的输出效果，即删除了`// DNA:RAW ` */
SUPER(1010100, "ConstantEnumTemplate", "性别", "性别")
// DNA:RAW SUPER(1010100, "ConstantEnumTemplate", "性别", "性别")
```

## 4.主任RNA

RNA好比车间主任，定义执行指令，在merge时调用`执行引擎`（默认java的js）替换文本。

 * 一个`执行引擎`可以执行多种`类型`的`功能体`，一种类型简称一个`引擎`。
 * `引擎`的命名，必须为`英数`，区分大小写，如`js`。
 * 命名可以用`!`结尾，如`js!`，表示仅执行，但忽略输出（用空字符串代替）。

其中各`引擎`的实现和执行上下文是不一样的，即变量作用域不一样，存在以下2个级别，

 * `js`同一次merge使用同一个engine，同一个上下文，为`session`级别。
 * `sh`依赖于bash设置，每次上下文不同，属于Share`nothing`级别。

RNA中默认的`引擎`默认为`map`。用户可以添加引擎，系统提供了以下几个。

 * `map` - `session`级，以`功能体`为key，到`环境`中取值，没有则输出key。
 * `raw` - `nothing`级，直接把`功能体`当字符串返回，不会展开转义字符。
 * `js` - `session`级，以java的ScriptEngine执行js脚本，捕获最后一个求值。
 * `cmd` - `nothing`级，以`cmd /c`直接运行，捕获std_out输出
 * `sh` - `nothing`级，以`bash -c`直接运行，捕获std_out输出。注意引号块和转义
 * `exe` - `nothing`级，直接执行，解析引号块和转义，捕获std_out输出。

### 4.1.RNA:USE 使用变量

语法：`RNA:USE` `空白`+ `界定` `查找` `界定` `变量` `界定` `作用`?

`SET`的`RNA`版本，区别在于从`环境`中取得`变量`值，而非底层模板的字面量替换。

``` js
// DNA:USE /meepo/user.home/
var userHome = "meepo";
/* 读取System.getProperty("user.home")。底层模板输出为:
var userHome = "/home/trydofor"; 
*/
```

### 4.2.RNA:PUT 存入变量

语法：`RNA:PUT` `空白`+ `引擎`? `界定` `变量` `界定` `功能体` `界定`

指定`引擎`执行`功能体`，把执行结果存入`环境`，以便其他`RNA`取值。

 * `环境`指米波context和部分脚本引擎上下文。
 * `引擎`，参考引擎说明。
 * `界定`同`SET`。
 * `变量`指存入上下文的变量，非母版字面量。
 * `功能体`由具体的执行引擎执行，如spring，则可当做SpEL执行。

``` js
// DNA:PUT os/who/basename $(pwd)/
/* 把结果`pro.fessional.meepo`放入米波的执行环境 */
```

### 4.3.RNA:RUN 每次执行

语法：`RNA:RUN` `空白`+ `引擎`? `界定` `查找` `界定` `功能体` `界定` `作用`?

`PUT`和`USE`的结合体，区别在于，

 * `功能体`执行结果立即使用，不存入`变量`
 * 每次都执行，类似计数器功能，每次调用都会自增，无缓存。

``` js
// DNA:RUN os/rand/echo $RANDOM/1-3
var userName = "meepo-rand";
var userPass = "rand-rand";
/* 每次都获得随机数，输出3次。底层模板输出为:
var userName = "meepo-12599";
var userPass = "16345-31415";
*/
```

## 5.应用举例


